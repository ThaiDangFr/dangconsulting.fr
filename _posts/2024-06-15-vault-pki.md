---
layout: post
title: Hashicorp Vault PKI secret engine
date: 2024-06-15 12:00:00-0000
description: Comment gérer ses certificats avec Vault
tags: tech
categories: education
giscus_comments: true
related_posts: false
toc:
  beginning: true
---

installer client vault avec asdf
================================

asdf permet d'installer des plugin, pour avoir des outils sous une certaine version

exemple : awscli, k0s, kubectl, terraform, trivy, vault, yq

```bash
asdf plugin list          # list les plugin installés
asdf update               # mise à jour de asdf
asdf plugin update --all  # mise à jour de tous les plugins


asdf plugin-add vault
asdf list all vault
asdf install vault 1.16.3 # install une version spécifique

asdf global vault 1.16.3  # cette version sera dispo partout
#asdf local vault 1.16.3  # => version dispo que dans le répertoire courant
asdf current              # list les versions actuelles


asdf plugin-update vault

```

curl et le ssl sous Fedora
===========================
Afin de pouvoir faire des curl vers des machines interne dont le SSL a été signé par votre PKI, il faut déployer votre CA root sur votre desktop afin qu'elle puisse le truster.

```
sudo cp /mnt/secure/certificats/tls/ca.crt /etc/pki/ca-trust/source/anchors/dangconsulting-root-ca.crt
sudo update-ca-trust
```

pki secret engine
=================
Le PKI secret engine de Vault permet de gérer une PKI interne en évitant d'exposer les clefs privées.

Il permet de :
- créer ou importer un CA root
- créer un CA intermédiaire
- appeler un role sur ce CA intermédiaire afin de récuppérer un certificat signé

Mais avant tout, il faut disposer de certains droits afin de pouvoir gérer la pki, donc nous allons créer une policy à associer au user gestionnaire.

Créer une policy à associer au user gestionnaire
```bash
vault policy write pki - <<EOF
# Enable secrets engine
path "sys/mounts/*" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

# List enabled secrets engine
path "sys/mounts" {
  capabilities = [ "read", "list" ]
}

# Work with pki secrets engine
path "pki*" {
  capabilities = [ "create", "read", "update", "delete", "list", "sudo", "patch" ]
}
EOF

vault policy read pki
```

Import d'une CA root déjà existante
```bash
vault secrets enable -path=pki_root pki
vault secrets tune -max-lease-ttl=87600h pki_root

vault write -format=json pki_root/config/ca pem_bundle="$(cat /mnt/secure/certificats/tls/ca.crt /mnt/secure/certificats/tls/ca.key)"
vault list pki_root/issuers/
vault write pki_root/config/urls issuing_certificates="https://vault.home/v1/pki/ca" crl_distribution_points="https://vault.home/v1/pki/crl"
```

Création d'un CA intermédiaire
```bash
vault secrets enable -path=pki_intermediate pki
vault secrets tune -max-lease-ttl=43800h pki_intermediate

# create csr
vault write -format=json pki_intermediate/intermediate/generate/internal \
     common_name="Intermediate CA" \
     | jq -r '.data.csr' > pki_intermediate.csr

# create crt and sign it with root ca
vault write -format=json pki_root/root/sign-intermediate \
     csr=@pki_intermediate.csr \
     format=pem_bundle ttl="43800h" \
     | jq -r '.data.certificate' > intermediate.cert.pem

# import the intermediate certificate
vault write pki_intermediate/intermediate/set-signed certificate=@intermediate.cert.pem
rm -f pki_intermediate.csr intermediate.cert.pem 
```

Création d'un role et demande de certificat au travers de ce role
```bash
vault write pki_intermediate/roles/home allowed_domains=home allow_subdomains=true max_ttl=720h
vault write pki_intermediate/issue/home common_name=toto.home ttl="24h"
```

Lister les certificats créés
```bash
# return a list of serial_number
vault list pki_intermediate/certs

# get details on the certificate
vault read pki_intermediate/cert/<serial_number>

# download a certificate
vault read -field=certificate pki_intermediate/cert/<serial_number> > toto.home.crt
```

Révoquer un certificat
```bash
vault write pki_intermediate/revoke serial_number=<serial_number>
```

Maintenance
```bash
# manually delete expired certificates
vault write pki_intermediate/tidy tidy_cert_store=true tidy_revoked_certs=true

# activate the automatic tidy of expired certificates or issuers
vault write pki_intermediate/config/auto-tidy enabled=true tidy_expired_issuers=true tidy_revoked_cert_issuer_associations=true tidy_cert_store=true tidy_revoked_certs=true safety_buffer=24h
```

Références
==========
- https://docs.tetrate.io/service-bridge/1.5.x/setup/certificate/external-ca/vault
- https://developer.hashicorp.com/vault/tutorials/secrets-management/pki-engine
- https://developer.hashicorp.com/vault/api-docs/secret/pki